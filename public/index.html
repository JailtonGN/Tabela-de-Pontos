<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Sistema de Pontos - Meus Filhos</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="modal-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>üèÜ Sistema de Pontos</h1>
                    <p>Gerenciando os pontos dos meus filhos</p>
                </div>
                <div class="header-right">
                    <!-- Status do servidor -->
                    <div class="status-container">
                        <div id="status-indicator" class="status-indicator online"></div>
                        <span id="status-text" class="status-text online">üü¢ Online</span>
                    </div>
                    <!-- Status WebSocket no canto superior direito -->
                    <div id="websocket-status" class="websocket-status connecting">
                        üîÑ Conectando...
                    </div>
                    <!-- Bot√£o de configura√ß√µes logo abaixo do status -->
                    <button id="btn-configuracoes" class="btn-config" title="Configura√ß√µes">
                        <span class="config-icon">‚öôÔ∏è</span> Configura√ß√µes
                    </button>
                </div>
            </div>
            
            <!-- Bot√µes de a√ß√£o mais abaixo -->
            <div class="header-actions">
                <button id="btn-sync-atividades" class="btn-sync" title="Sincronizar Atividades com Servidor">
                    ‚òÅÔ∏è Sync
                </button>
                <button id="btn-atualizar" class="btn-atualizar" title="Sincronizar Dados Manualmente">
                    üîÑ Atualizar
                </button>
                <button id="btn-sair" class="btn-sair" title="Sair do Sistema">
                    üö™ Sair
                </button>
            </div>
        </header>

        <!-- Se√ß√£o Principal -->
        <div class="main-content">
            <!-- Dashboard de Pontos -->
            <div class="dashboard-section">
                <div class="card pontos-card">
                    <h2>üìä Pontos Atuais</h2>
                    <div class="pontos-display">
                        <!-- Filhos ser√£o renderizados dinamicamente aqui -->
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de A√ß√µes -->
            <div class="acoes-section">
                <div class="acoes-grid">
                    <!-- Adicionar Pontos -->
                    <div class="card acao-card">
                        <h2>üéØ Adicionar Pontos</h2>
                        <div class="form-group">
                            <label for="filho-adicionar">Filho:</label>
                            <select id="filho-adicionar" class="form-control">
                                <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="atividade-adicionar">üéØ Escolha a atividade:</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-header" id="dropdown-header-adicionar">
                                    <span class="dropdown-placeholder">üîç Selecione uma atividade...</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                                <div class="dropdown-content" id="dropdown-content-adicionar">
                                    <div class="dropdown-search">
                                        <input type="text" placeholder="üîç Buscar atividade..." id="search-adicionar">
                                    </div>
                                    <div class="dropdown-options" id="options-adicionar">
                                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                    </div>
                                </div>
                                <select id="atividade-adicionar" class="hidden-select">
                                    <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                </select>
                            </div>
                            <small class="form-hint">üí° Configure mais atividades no bot√£o ‚öôÔ∏è acima</small>
                        </div>
                        <button id="btn-adicionar" class="btn btn-success">‚ûï Adicionar Pontos</button>
                    </div>

                    <!-- Remover Pontos -->
                    <div class="card acao-card">
                        <h2>‚ùå Remover Pontos</h2>
                        <div class="form-group">
                            <label for="filho-remover">Filho:</label>
                            <select id="filho-remover" class="form-control">
                                <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="atividade-remover">üéØ Escolha a atividade:</label>
                            <div class="custom-dropdown">
                                <div class="dropdown-header" id="dropdown-header-remover">
                                    <span class="dropdown-placeholder">üîç Selecione uma atividade...</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                                <div class="dropdown-content" id="dropdown-content-remover">
                                    <div class="dropdown-search">
                                        <input type="text" placeholder="üîç Buscar atividade..." id="search-remover">
                                    </div>
                                    <div class="dropdown-options" id="options-remover">
                                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                    </div>
                                </div>
                                <select id="atividade-remover" class="hidden-select">
                                    <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                </select>
                            </div>
                            <small class="form-hint">üí° Configure mais atividades no bot√£o ‚öôÔ∏è acima</small>
                        </div>
                        <button id="btn-remover" class="btn btn-danger">‚ûñ Remover Pontos</button>
                    </div>
                </div>

                <!-- Pontos Avulsos -->
                <div class="card pontos-avulsos-card">
                    <h2>‚ö° Pontos Avulsos</h2>
                    <p class="card-subtitle">A√ß√µes r√°pidas para pontos individuais</p>
                    <div class="pontos-avulsos-grid">
                        <div class="ponto-avulso">
                            <h3>‚ûï Adicionar</h3>
                            <div class="form-group">
                                <label for="filho-avulso-add">Filho:</label>
                                <select id="filho-avulso-add" class="form-control">
                                    <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pontos-avulso-add">Pontos:</label>
                                <input type="number" id="pontos-avulso-add" class="form-control" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="motivo-avulso-add">Motivo:</label>
                                <input type="text" id="motivo-avulso-add" class="form-control" placeholder="Motivo r√°pido">
                            </div>
                            <button id="btn-avulso-add" class="btn btn-success">‚ûï Adicionar Pontos</button>
                        </div>
                        
                        <div class="ponto-avulso">
                            <h3>‚ûñ Remover</h3>
                            <div class="form-group">
                                <label for="filho-avulso-remove">Filho:</label>
                                <select id="filho-avulso-remove" class="form-control">
                                    <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pontos-avulso-remove">Pontos:</label>
                                <input type="number" id="pontos-avulso-remove" class="form-control" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="motivo-avulso-remove">Motivo:</label>
                                <input type="text" id="motivo-avulso-remove" class="form-control" placeholder="Motivo r√°pido">
                            </div>
                            <button id="btn-avulso-remove" class="btn btn-danger">‚ûñ Remover Pontos</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Hist√≥rico -->
            <div class="historico-section">
                <div class="card historico-card">
                    <h2>üìù Hist√≥rico Recente</h2>
                    <div class="historico-header">
                        <div class="filtros-container">
                            <div class="filtro-grupo">
                                <label for="filtro-filho">üë• Filtrar por filho:</label>
                                <select id="filtro-filho" class="filtro-select">
                                    <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                                </select>
                            </div>
                            <div class="filtro-grupo">
                                <label for="filtro-periodo">üìÖ Filtrar por per√≠odo:</label>
                                <select id="filtro-periodo" class="filtro-select">
                                    <option value="todos">üìÖ Todos os per√≠odos</option>
                                    <option value="hoje">üìÖ Hoje</option>
                                    <option value="ontem">üìÖ Ontem</option>
                                    <option value="semana">üìÖ √öltimos 7 dias</option>
                                    <option value="mes">üìÖ √öltimos 30 dias</option>
                                    <option value="personalizado">üìÖ Per√≠odo personalizado</option>
                                </select>
                            </div>
                            <div class="filtro-grupo" id="filtro-datas-personalizadas" style="display: none;">
                                <label>üìÖ Per√≠odo personalizado:</label>
                                <div class="datas-container">
                                    <input type="date" id="data-inicio" class="filtro-date">
                                    <span>at√©</span>
                                    <input type="date" id="data-fim" class="filtro-date">
                                </div>
                            </div>
                        </div>
                        <div class="botoes-compartilhar">
                            <button id="btn-compartilhar" class="btn btn-share">üì§ Compartilhar</button>
                        </div>
                    </div>
                    <div id="historico" class="historico-lista">
                        <div class="historico-item">
                            <span class="data">Hoje</span>
                            <span class="acao">‚ûï Jo√£o ganhou 10 pontos</span>
                            <span class="motivo">Arrumou o quarto</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Lembretes -->
            <div class="lembretes-section">
                <div class="card lembretes-card">
                    <h2>üìù Lembretes das Crian√ßas</h2>
                    
                    <!-- √Årea para Crian√ßas (Modo Visitante) -->
                    <div id="area-lembretes-criancas" class="lembretes-criancas" style="display: none;">
                        <h3>üí¨ Deixe um lembrete para os pais</h3>
                        <div class="lembrete-form">
                            <div class="form-group">
                                <label for="lembrete-crianca">üë§ Quem est√° escrevendo:</label>
                                <select id="lembrete-crianca" class="form-control">
                                    <option value="">Selecione uma crian√ßa...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lembrete-mensagem">üí≠ Sua mensagem:</label>
                                <textarea id="lembrete-mensagem" class="form-control" rows="3" 
                                    placeholder="Escreva aqui o que voc√™ quer lembrar aos pais..." maxlength="500"></textarea>
                                <small class="char-count">0/500 caracteres</small>
                            </div>
                            <button id="btn-enviar-lembrete" class="btn btn-primary">üì§ Enviar Lembrete</button>
                        </div>
                    </div>

                    <!-- √Årea para Pais/Admin -->
                    <div id="area-lembretes-pais" class="lembretes-pais" style="display: none;">
                        <div class="lembretes-header">
                            <div class="lembretes-stats">
                                <span id="contador-lembretes" class="badge">0 n√£o lidos</span>
                            </div>
                            <div class="lembretes-actions">
                                <button id="btn-limpar-lembretes" class="btn btn-warning btn-sm">üßπ Limpar Lidos</button>
                            </div>
                        </div>
                        <div id="lista-lembretes" class="lista-lembretes">
                            <!-- Lembretes ser√£o carregados dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="modal-configuracoes" class="modal-confirmacao">
        <div class="modal-confirmacao-content">
            <div class="modal-confirmacao-header">
                <h3>‚öôÔ∏è Configura√ß√µes do Sistema</h3>
                <button class="modal-confirmacao-close" id="fechar-modal">&times;</button>
            </div>
            <div class="modal-confirmacao-body">
                <div class="config-tabs">
                    <button class="tab-btn active" data-tab="filhos">üë• Filhos</button>
                    <button class="tab-btn" data-tab="pontos">üéØ Atividades</button>
                </div>

                <!-- Aba Filhos -->
                <div class="tab-content active" id="tab-filhos">
                    <h3>üë• Configura√ß√µes dos Filhos</h3>
                    <div class="config-group">
                        <h4>üìù Nomes dos Filhos</h4>
                        <div class="input-group">
                            <label>üë¶ Filho 1:</label>
                            <input type="text" id="config-nome1" class="form-control" placeholder="Nome do primeiro filho">
                        </div>
                        <div class="input-group">
                            <label>üëß Filho 2:</label>
                            <input type="text" id="config-nome2" class="form-control" placeholder="Nome do segundo filho">
                        </div>
                        <div class="input-group">
                            <label>üë∂ Filho 3:</label>
                            <input type="text" id="config-nome3" class="form-control" placeholder="Nome do terceiro filho">
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>üé≠ Emojis Personalizados</h4>
                        <div class="input-group">
                            <label>Emoji Filho 1:</label>
                            <input type="text" id="emoji-filho1" class="form-control" maxlength="2" placeholder="üë¶">
                        </div>
                        <div class="input-group">
                            <label>Emoji Filho 2:</label>
                            <input type="text" id="emoji-filho2" class="form-control" maxlength="2" placeholder="üëß">
                        </div>
                        <div class="input-group">
                            <label>Emoji Filho 3:</label>
                            <input type="text" id="emoji-filho3" class="form-control" maxlength="2" placeholder="üë∂">
                        </div>
                    </div>
                </div>

                <!-- Aba Atividades -->
                <div class="tab-content" id="tab-pontos">
                    <h3>üéØ Gerenciar Atividades</h3>
                    
                    <!-- Atividades Positivas -->
                    <div class="config-group">
                        <h4>‚ûï Atividades Positivas</h4>
                        <div class="atividades-container">
                            <div class="nova-atividade-form">
                                <div class="input-row">
                                    <input type="text" id="nova-atividade-positiva" class="form-control" placeholder="Ex: Arrumou o quarto">
                                    <input type="number" id="pontos-atividade-positiva" class="form-control pontos-input" value="10" min="1" max="100">
                                    <button onclick="adicionarAtividade('positiva')" class="btn btn-success btn-sm">‚ûï</button>
                                </div>
                            </div>
                            <div id="lista-atividades-positivas" class="lista-atividades"></div>
                        </div>
                    </div>

                    <!-- Atividades Negativas -->
                    <div class="config-group">
                        <h4>‚ûñ Atividades Negativas</h4>
                        <div class="atividades-container">
                            <div class="nova-atividade-form">
                                <div class="input-row">
                                    <input type="text" id="nova-atividade-negativa" class="form-control" placeholder="Ex: N√£o arrumou o quarto">
                                    <input type="number" id="pontos-atividade-negativa" class="form-control pontos-input" value="5" min="1" max="100">
                                    <button onclick="adicionarAtividade('negativa')" class="btn btn-danger btn-sm">‚ûñ</button>
                                </div>
                            </div>
                            <div id="lista-atividades-negativas" class="lista-atividades"></div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h4>üîÑ Atividades Padr√£o</h4>
                        <p class="help-text">‚úÖ <strong>Configura√ß√£o:</strong> Use as se√ß√µes acima para gerenciar atividades.</p>
                    </div>
                </div>

                <!-- Aba de Backup removida -->
            </div>
            <div class="modal-confirmacao-footer">
                <div class="footer-left">
                    <button id="btn-baixar-log" class="btn btn-primary admin-only">üìã Baixar Log</button>
                    <button id="btn-resetar-pontos" class="btn btn-warning admin-only">üîÑ Resetar Pontos</button>
                    <button id="btn-limpar-historico" class="btn btn-danger admin-only">üóëÔ∏è Limpar Hist√≥rico</button>
                </div>
                <div class="footer-right">
                    <button id="btn-salvar-config" class="btn btn-success">üíæ Salvar Configura√ß√µes</button>
                    <button id="btn-cancelar-config" class="btn btn-secondary">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container de Notifica√ß√µes -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Modal de Confirma√ß√£o Moderno -->
    <div id="modal-confirmacao" class="modal-confirmacao">
        <div class="modal-confirmacao-content">
            <div class="modal-confirmacao-header">
                <h3 id="modal-confirmacao-titulo">‚ö†Ô∏è Confirma√ß√£o</h3>
                <button class="modal-confirmacao-close" id="modal-confirmacao-close">&times;</button>
            </div>
            <div class="modal-confirmacao-body">
                <p id="modal-confirmacao-mensagem">Tem certeza que deseja continuar?</p>
            </div>
            <div class="modal-confirmacao-footer">
                <button class="btn btn-secondary" id="modal-confirmacao-cancelar">Cancelar</button>
                <button class="btn btn-danger" id="modal-confirmacao-confirmar">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- WebSocket Sync habilitado -->
    <script src="websocket-sync.js"></script>

    <!-- M√≥dulo de Notifica√ß√µes Centralizado -->
    <script src="utils/toast-utils.js"></script>
    
    <!-- Sistema de Autentica√ß√£o -->
    <script>
        // Definir AuthUtils antes de carregar outros scripts
        window.AuthUtils = {
            isLoggedIn() {
                const session = localStorage.getItem('userSession');
                if (!session) return false;
                
                const userData = JSON.parse(session);
                const now = new Date();
                const expires = new Date(userData.expires);
                
                return now < expires;
            },

            getCurrentUser() {
                if (!this.isLoggedIn()) return null;
                return JSON.parse(localStorage.getItem('userSession'));
            },

            hasPermission(permission) {
                const user = this.getCurrentUser();
                return user && user.permissions.includes(permission);
            },

            logout() {
                localStorage.removeItem('userSession');
                if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    window.location.href = 'https://tabela-de-pontos.onrender.com/login';
                } else {
                    window.location.href = '/login.html';
                }
            },

            requireAuth() {
                if (!this.isLoggedIn()) {
                    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                        window.location.href = 'https://tabela-de-pontos.onrender.com/login';
                    } else {
                        window.location.href = '/login.html';
                    }
                    return false;
                }
                return true;
            }
        };

        // Verificar redirecionamento para login apenas se n√£o estiver logado
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            // Aguardar um momento para o localStorage carregar, ent√£o verificar se est√° logado
            setTimeout(() => {
                if (!window.AuthUtils.isLoggedIn()) {
                    console.log('üîí Usu√°rio n√£o logado, redirecionando para login...');
                    window.location.href = 'https://tabela-de-pontos.onrender.com/login';
                } else {
                    console.log('‚úÖ Usu√°rio j√° logado, mantendo na p√°gina principal');
                }
            }, 100);
        }
    </script>
    
    <!-- ‚ú® REFATORA√á√ÉO DRY: Utilit√°rios Centralizados -->
    <script src="utils/api-service.js"></script>
    <script src="utils/dom-utils.js"></script>
    <script src="utils/event-manager.js"></script>
    <script src="utils/state-manager.js"></script>
    <script src="utils/file-utils.js"></script>
    <script src="utils/validation-utils.js"></script>
    
    <!-- Scripts Principais -->
    <script src="script.js"></script>
</body>
</html>